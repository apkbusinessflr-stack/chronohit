
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tap Reflex — ChronoHit</title>
  <link rel="stylesheet" href="../../assets/chronohit.css" />
  <script type="module">
    import { ls, fmtMs } from "../../assets/utils.js";
    window.addEventListener('DOMContentLoaded', () => {
      const tap = document.getElementById('tap');
      const lastEl = document.getElementById('last');
      const avgEl = document.getElementById('avg');
      const bestEl = document.getElementById('best');
      const hiEl = document.getElementById('hi');
      const attemptsEl = document.getElementById('attempts');

      const MIN_HUMAN_MS = 60;
      const DELAY_MIN = 1200, DELAY_MAX = 2400;

      let state = 'idle', startTs = 0, sum = 0, attempts = 0, bestSingle = null;

      function render(){
        lastEl.textContent = window._last == null ? '—' : Math.round(window._last);
        avgEl.textContent = attempts ? Math.round(sum/attempts) : '—';
        attemptsEl.textContent = attempts;
        bestEl.textContent = bestSingle != null ? Math.round(bestSingle) : '—';
        const hi = ls.get('tap.hiAvg', null);
        hiEl.textContent = hi != null ? Math.round(hi) : '—';
      }

      function saveHi(){
        if (!attempts) return;
        const avg = sum/attempts;
        const prev = ls.get('tap.hiAvg', null);
        if (prev == null || avg < prev){
          ls.set('tap.hiAvg', Math.round(avg));
        }
      }

      function reset(){
        sum = 0; attempts = 0; bestSingle = null; window._last = null;
        tap.className = 'tap-area ready'; tap.textContent = 'Tap to start'; state = 'idle'; render();
      }

      function startWait(){
        state = 'waiting'; tap.className = 'tap-area wait'; tap.textContent = 'Wait...';
        const wait = Math.random()*(DELAY_MAX - DELAY_MIN) + DELAY_MIN;
        setTimeout(() => {
          if (state !== 'waiting') return;
          startTs = performance.now();
          state = 'go';
          tap.className = 'tap-area go'; tap.textContent = 'TAP!';
        }, wait);
      }

      tap.addEventListener('click', () => {
        if (state === 'idle'){ startWait(); return; }
        if (state === 'waiting'){
          tap.className = 'tap-area too-soon'; tap.textContent = 'Too soon!';
          setTimeout(reset, 800);
          return;
        }
        if (state === 'go'){
          const r = performance.now() - startTs;
          window._last = r;
          if (r >= MIN_HUMAN_MS){
            attempts++; sum += r;
            if (bestSingle == null || r < bestSingle) bestSingle = r;
            saveHi();
          }
          render();
          tap.className = 'tap-area ready'; tap.textContent = 'Nice! Tap again';
        }
      });

      reset();
    });
  </script>
</head>
<body>
<header class="header">
  <a href="../../" class="logo"><img src="../../assets/logo.svg" alt=""><span class="brand">ChronoHit</span></a>
</header>

<main class="container">
  <section class="card">
    <h1>Tap Reflex</h1>
    <div id="tap" class="tap-area ready" role="button" aria-label="Tap when it turns green">Tap to start</div>
    <div class="stats">
      <div class="stat"><div class="label">Last (ms)</div><div class="value" id="last">—</div></div>
      <div class="stat"><div class="label">Average (ms)</div><div class="value" id="avg">—</div></div>
      <div class="stat"><div class="label">Attempts</div><div class="value" id="attempts">0</div></div>
      <div class="stat"><div class="label">Best single (ms)</div><div class="value" id="best">—</div></div>
      <div class="stat"><div class="label">Hi-score (avg)</div><div class="value" id="hi">—</div></div>
    </div>
    <p class="lead">Anti-cheat: reactions &lt; 60ms are ignored.</p>
  </section>
</main>

<footer class="footer">© 2025 ChronoHit — Every millisecond counts</footer>
</body>
</html>
