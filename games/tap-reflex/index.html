<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tap Reflex — ChronoHit</title>
  <link rel="stylesheet" href="../../assets/chronohit.css" />

  <!-- Dynamic loaders -->
  <script src="../../assets/ga-loader.js"></script>
  <script src="../../assets/ads-loader.js"></script>

  <script type="module">
    import { ls, getDeviceId, todayKey, fetchJSON } from "../../assets/utils.js";
    const MIN_HUMAN_MS = 60;
    const MODES = { easy:{label:"Easy",range:[1500,2700]}, default:{label:"Default",range:[1200,2400]}, hard:{label:"Hard",range:[900,1800]} };
    const DAILY_LIMIT = 5, SUBMIT_MIN_ATTEMPTS = 5;

    let state="idle", startTs=0; let sum=0, attempts=0, bestSingle=null; let waitTimer=null; let mode="default";
    const deviceId = getDeviceId();

    let tapEl,lastEl,avgEl,bestEl,hiEl,attemptsEl,resetBtn,modeSel,submitBtn,leaderWrap,dailyCounterEl;

    const vibrate=(ms)=>{ try{ if(navigator.vibrate) navigator.vibrate(ms);}catch(_){} };
    const rnd=(a,b)=>Math.floor(a+Math.random()*(b-a+1));
    const setState=(s,text,cls)=>{ state=s; tapEl.className=`tap-area ${cls||""}`.trim(); tapEl.textContent=text; };
    const render=()=>{
      lastEl.textContent = window._last==null ? "—" : Math.round(window._last);
      avgEl.textContent  = attempts? Math.round(sum/attempts) : "—";
      attemptsEl.textContent = attempts;
      bestEl.textContent = bestSingle!=null? Math.round(bestSingle) : "—";
      const hi = ls.get("tap.hiAvg", null);
      hiEl.textContent = hi!=null? Math.round(hi) : "—";
    };
    const saveHi=()=>{ if(!attempts) return; const avg=sum/attempts; const prev=ls.get("tap.hiAvg",null); if(prev==null||avg<prev) ls.set("tap.hiAvg",Math.round(avg)); };
    const resetSession=()=>{ if(waitTimer){clearTimeout(waitTimer); waitTimer=null;} sum=0; attempts=0; bestSingle=null; window._last=null; setState("idle","Tap to start","ready"); render(); };
    const scheduleWait=()=>{ const [dmin,dmax]=MODES[mode].range; setState("waiting","Wait...","wait"); const wait=rnd(dmin,dmax); waitTimer=setTimeout(()=>{ startTs=performance.now(); setState("go","TAP!","go"); waitTimer=null; },wait); };
    const onTap=()=>{
      if(state==="idle"){ scheduleWait(); return; }
      if(state==="waiting"){ setState("toosoon","Too soon!","too-soon"); setTimeout(resetSession,700); return; }
      if(state==="go"){
        const r = performance.now()-startTs; window._last=r;
        if(r>=MIN_HUMAN_MS){ attempts++; sum+=r; if(bestSingle==null||r<bestSingle) bestSingle=r; saveHi(); vibrate(35); }
        render(); setState("idle","Nice! Tap again","ready");
      }
    };

    async function refreshDaily(){
      try{
        const j = await fetchJSON(`/api/daily?device=${encodeURIComponent(deviceId)}&day=${todayKey()}`);
        dailyCounterEl.textContent = `${j.used}/${DAILY_LIMIT}`;
        submitBtn.disabled = !(attempts>=SUBMIT_MIN_ATTEMPTS) || (j.used>=DAILY_LIMIT);
      }catch(e){
        dailyCounterEl.textContent = `—/${DAILY_LIMIT}`;
        submitBtn.disabled = !(attempts>=SUBMIT_MIN_ATTEMPTS);
      }
    }
    async function submitDaily(){
      if(attempts<SUBMIT_MIN_ATTEMPTS) return;
      const avg=Math.round(sum/attempts), best=Math.round(bestSingle||0);
      try{
        const r = await fetchJSON("/api/score", { method:"POST", body:JSON.stringify({ device:deviceId, day:todayKey(), avg, best, attempts, mode }) });
        await refreshDaily(); await loadLeaderboard(); alert(r.message||"Submitted!");
      }catch(e){ alert(e.data?.error||e.message||"Submit failed"); }
    }
    async function loadLeaderboard(){
      try{
        const j = await fetchJSON(`/api/leaderboard?range=daily&day=${todayKey()}&limit=20`);
        leaderWrap.innerHTML = renderTable(j.items||[]);
      }catch(e){ leaderWrap.innerHTML = `<div class="notice">Leaderboard unavailable.</div>`; }
    }
    function renderTable(items){
      if(!items.length) return `<div class="notice">No scores yet today. Be the first!</div>`;
      const rows = items.map((it,idx)=>`<tr><td>${idx+1}</td><td>${it.avg} ms</td><td>${it.attempts}</td><td>${it.mode}</td></tr>`).join("");
      return `<table class="table"><thead><tr><th>#</th><th>Avg</th><th>Attempts</th><th>Mode</th></tr></thead><tbody>${rows}</tbody></table>`;
    }

    window.addEventListener("DOMContentLoaded", async ()=>{
      tapEl=document.getElementById("tap"); lastEl=document.getElementById("last"); avgEl=document.getElementById("avg");
      bestEl=document.getElementById("best"); hiEl=document.getElementById("hi"); attemptsEl=document.getElementById("attempts");
      resetBtn=document.getElementById("reset"); modeSel=document.getElementById("mode"); submitBtn=document.getElementById("submit");
      leaderWrap=document.getElementById("leader"); dailyCounterEl=document.getElementById("daily-counter");

      tapEl.addEventListener("click", onTap);
      tapEl.addEventListener("keydown",(e)=>{ if(e.key===" "||e.key==="Enter"){ e.preventDefault(); onTap(); }});
      resetBtn.addEventListener("click", ()=>{ resetSession(); refreshDaily(); });
      modeSel.addEventListener("change",(e)=>{ mode=e.target.value; resetSession(); });

      resetSession(); await refreshDaily(); await loadLeaderboard();
      submitBtn.addEventListener("click", submitDaily);

      // Inject the ad slot under stats
      if (window.ChronoAds) ChronoAds.load({ targetId: 'ad-tapreflex', slotKey: 'tapreflex' });
    });
  </script>
</head>
<body>
<header class="header">
  <a href="../../" class="logo"><img src="../../assets/logo.svg" alt=""><span class="brand">ChronoHit</span></a>
</header>

<main class="container">
  <section class="card">
    <div class="row"><h1 style="margin:0">Tap Reflex</h1><span class="badge">DAILY CHALLENGE</span></div>
    <p class="lead">Wait until the panel turns green, then tap. Choose mode and submit your <b>Daily Challenge</b> (best average wins).</p>

    <div class="row" style="margin-bottom:8px">
      <label class="small">Mode:</label>
      <select id="mode" class="select" aria-label="Mode">
        <option value="easy">Easy (1.5–2.7s)</option>
        <option value="default" selected>Default (1.2–2.4s)</option>
        <option value="hard">Hard (0.9–1.8s)</option>
      </select>
      <span class="small">Daily submissions used: <b id="daily-counter">—/5</b></span>
    </div>

    <div id="tap" class="tap-area ready" tabindex="0" role="button" aria-label="Tap when it turns green">Tap to start</div>

    <div class="stats">
      <div class="stat"><div class="label">Last (ms)</div><div class="value" id="last">—</div></div>
      <div class="stat"><div class="label">Average (ms)</div><div class="value" id="avg">—</div></div>
      <div class="stat"><div class="label">Attempts</div><div class="value" id="attempts">0</div></div>
      <div class="stat"><div class="label">Best single (ms)</div><div class="value" id="best">—</div></div>
      <div class="stat"><div class="label">Hi-score (avg)</div><div class="value" id="hi">—</div></div>
    </div>

    <div class="row" style="margin-top:10px">
      <button id="reset" class="btn" type="button">Reset session</button>
      <button id="submit" class="btn" type="button" disabled>Submit to Daily Leaderboard</button>
    </div>

    <div id="leader" style="margin-top:12px"></div>
    <p class="small">Anti-cheat: reactions &lt; 60ms ignored. No decimals. Anonymous device ID.</p>
  </section>

  <!-- Ad container under the game stats (dynamic via ChronoAds) -->
  <section class="card">
    <h2>Ad</h2>
    <div id="ad-tapreflex" class="placeholder-ad"></div>
  </section>
</main>

<footer class="footer">© 2025 ChronoHit — Every millisecond counts</footer>
</body>
</html>
