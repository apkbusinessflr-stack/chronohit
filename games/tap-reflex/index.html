<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Reaction (Classic) — ChronoHit</title>
  <link rel="stylesheet" href="../../assets/chronohit.css"/>

  <style>
    .padgrid{display:grid;gap:10px;margin-top:10px}
    .pad{aspect-ratio:1/1;border:1px solid var(--border);border-radius:14px;background:#121922;display:flex;align-items:center;justify-content:center;font-weight:800}
    .pad.active{background:#1f6838}
    .topbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
    .select{background:#0e1420;border:1px solid var(--border);border-radius:10px;padding:8px 10px;color:var(--muted)}
    .hud{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .hud .stat{min-width:140px}
    .endbox{margin-top:12px;padding:12px;border:1px dashed var(--border);border-radius:12px}
  </style>

  <script type="module">
    import { ls } from "../../assets/utils.js";

    // ----- Config per difficulty (reaction window & cycles)
    const DIFFS = {
      easy:   { label: "Easy",   window:[700,800],  cycles:20, jitter:0,   layout:[3,4] },
      medium: { label: "Medium", window:[500,600],  cycles:24, jitter:0,   layout:[3,4] },
      hard:   { label: "Hard",   window:[350,450],  cycles:28, jitter:30,  layout:[3,4] },
      insane: { label: "Insane", window:[250,320],  cycles:32, jitter:30,  layout:[3,4] }
    };

    // ----- State
    let pads = [];
    let active = -1;
    let playing = false;
    let cycleIdx = 0;
    let startTs = 0;
    let timerId = null;
    let score = 0, penalties = 0, streak = 0, streakMax = 0;
    let sum = 0, hits = 0, bestSingle = null;
    let chosen = "easy";

    // Elements
    let grid, lastEl, avgEl, bestEl, streakEl, scoreEl, cyclesEl, diffSel, startBtn, endBox;

    // Utils
    const rnd = (a,b)=>a+Math.random()*(b-a)|0;
    const now = ()=>performance.now();
    const inHuman = (ms)=>ms>=60; // anti-cheat: reject <60ms

    function layoutFor(diffKey){
      const [cols, rows] = DIFFS[diffKey].layout;
      return { cols, rows, n: cols*rows }; // 3x4=12 pads
    }

    function buildGrid(){
      const { cols, rows, n } = layoutFor(chosen);
      grid.style.gridTemplateColumns = `repeat(${cols},1fr)`;
      grid.innerHTML = "";
      pads = [];
      for(let i=0;i<n;i++){
        const b = document.createElement("button");
        b.className = "pad";
        b.setAttribute("aria-label", `Pad ${i+1}`);
        b.addEventListener("click", ()=>onPad(i));
        grid.appendChild(b);
        pads.push(b);
      }
    }

    function setActive(i){
      if (active>=0) pads[active].classList.remove("active");
      active = i;
      if (i>=0) pads[i].classList.add("active");
    }

    function resetRound(){
      clearTimeout(timerId);
      timerId = null;
      setActive(-1);
      cycleIdx = 0;
      score = 0; penalties = 0; streak = 0; streakMax = 0;
      sum = 0; hits = 0; bestSingle = null;
      updateHUD();
      endBox.hidden = true;
    }

    function updateHUD(){
      cyclesEl.textContent = `${cycleIdx} / ${DIFFS[chosen].cycles}`;
      scoreEl.textContent  = score;
      streakEl.textContent = `${streak} (max ${streakMax})`;
      lastEl.textContent   = (window._last==null? "—" : Math.round(window._last));
      avgEl.textContent    = hits? Math.round(sum/hits) : "—";
      bestEl.textContent   = bestSingle!=null? Math.round(bestSingle) : "—";
    }

    function scheduleNext(){
      const d = DIFFS[chosen];
      const [wMin, wMax] = d.window;
      const windowMs = rnd(wMin, wMax) + (d.jitter? (Math.random()<0.5?-d.jitter:d.jitter):0);
      const idx = rnd(0, pads.length-1);
      setActive(idx);
      startTs = now();

      // auto LATE if no tap in time window
      timerId = setTimeout(()=>{
        // player missed → LATE
        setActive(-1);
        penalties++;
        streak = 0;
        score -= 1;
        cycleIdx++;
        updateHUD();
        nextCycle();
      }, Math.max(120, windowMs)); // window guard
    }

    function onPad(i){
      if (!playing) return;
      if (i!==active){
        // tap σε σβηστό → penalty
        penalties++;
        streak = 0;
        score -= 1;
        updateHUD();
        return;
      }
      // HIT
      const r = now()-startTs;
      window._last = r;
      if (inHuman(r)){
        hits++;
        sum += r;
        if (bestSingle==null || r<bestSingle) bestSingle = r;
        score += 1;
        streak++;
        if (streak>streakMax) streakMax = streak;
      }
      clearTimeout(timerId); timerId=null;
      setActive(-1);
      cycleIdx++;
      updateHUD();
      nextCycle();
    }

    function nextCycle(){
      const d = DIFFS[chosen];
      if (cycleIdx >= d.cycles){ return finish(); }
      // μικρή παύση πριν το επόμενο άναμμα για ρυθμό
      setTimeout(scheduleNext, 180);
    }

    function finish(){
      playing = false;
      setActive(-1);
      // combo & speed bonus rules
      let bonus = 0;
      if (streakMax>=5) bonus += Math.floor(streakMax/5); // +1 ανά 5 streak
      const avg = hits? (sum/hits) : null;
      if (avg!=null && avg<300) bonus += 1; // speed bonus
      const finalScore = score + bonus;

      // αποθήκευση leader-ish (local)
      const key = `reaction.hiAvg.${chosen}`;
      const prev = ls.get(key, null);
      if (avg!=null && (prev==null || avg<prev)) ls.set(key, Math.round(avg));

      endBox.innerHTML = `
        <div><b>Round summary</b></div>
        <div>Score: <b>${finalScore}</b> (base ${score} / bonus ${bonus})</div>
        <div>Avg reaction: <b>${avg!=null? Math.round(avg)+' ms' : '—'}</b></div>
        <div>Best single: <b>${bestSingle!=null? Math.round(bestSingle)+' ms' : '—'}</b></div>
        <div>Max streak: <b>${streakMax}</b></div>
        <div>Penalties: <b>${penalties}</b></div>
      `;
      endBox.hidden = false;
      startBtn.disabled = false;
      startBtn.textContent = "Play again";
    }

    function start(){
      if (playing) return;
      resetRound();
      playing = true;
      startBtn.disabled = true;
      startBtn.textContent = "Playing…";
      scheduleNext();
    }

    window.addEventListener("DOMContentLoaded", ()=>{
      // bind UI
      grid      = document.getElementById("grid");
      lastEl    = document.getElementById("last");
      avgEl     = document.getElementById("avg");
      bestEl    = document.getElementById("best");
      streakEl  = document.getElementById("streak");
      scoreEl   = document.getElementById("score");
      cyclesEl  = document.getElementById("cycles");
      diffSel   = document.getElementById("diff");
      startBtn  = document.getElementById("start");
      endBox    = document.getElementById("endbox");

      // difficulty select
      diffSel.addEventListener("change", (e)=>{
        chosen = e.target.value;
        buildGrid();
        resetRound();
      });

      buildGrid();
      resetRound();
      startBtn.addEventListener("click", start);
    });
  </script>
</head>
<body>
<header class="header">
  <a href="../../" class="logo"><img src="../../assets/logo.svg" alt=""><span class="brand">ChronoHit</span></a>
</header>

<main class="container">
  <section class="card">
    <h1>Reaction (Classic)</h1>
    <p class="lead">Tap the lit pad within the reaction window. 10–12 pads grid, 20–32 cycles per round depending on difficulty.</p>

    <div class="topbar">
      <select id="diff" class="select" aria-label="Difficulty">
        <option value="easy">Easy — 700–800ms / 20 cycles</option>
        <option value="medium">Medium — 500–600ms / 24 cycles</option>
        <option value="hard">Hard — 350–450ms / 28 cycles (+jitter)</option>
        <option value="insane">Insane — 250–320ms / 32 cycles (+jitter)</option>
      </select>
      <button id="start" class="btn">Start round</button>
    </div>

    <div id="grid" class="padgrid"></div>

    <div class="hud">
      <div class="stat"><div class="label">Cycle</div><div class="value" id="cycles">0 / 0</div></div>
      <div class="stat"><div class="label">Score</div><div class="value" id="score">0</div></div>
      <div class="stat"><div class="label">Streak (max)</div><div class="value" id="streak">0</div></div>
      <div class="stat"><div class="label">Last (ms)</div><div class="value" id="last">—</div></div>
      <div class="stat"><div class="label">Average (ms)</div><div class="value" id="avg">—</div></div>
      <div class="stat"><div class="label">Best single (ms)</div><div class="value" id="best">—</div></div>
    </div>

    <div id="endbox" class="endbox" hidden></div>

    <p class="lead" style="margin-top:8px">
      Rules: +1 per HIT, −1 for LATE or wrong tap. Combo bonus +1 per 5-streak, speed bonus +1 if avg &lt; 300ms. Anti-cheat: reactions &lt; 60ms ignored.
    </p>
  </section>
</main>

<footer class="footer">© 2025 ChronoHit — Every millisecond counts</footer>
</body>
</html>
