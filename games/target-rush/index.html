<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Target Rush — ChronoHit</title>
  <link rel="stylesheet" href="/assets/chronohit.css" />

  <!-- Dynamic loaders -->
  <script src="/assets/ga-loader.js"></script>
  <script src="/assets/ads-loader.js"></script>

  <style>
    /* ===== Arena ===== */
    .arena{
      position:relative; width:100%; height:360px;
      background:#0b1117; border:1px solid var(--border);
      border-radius:16px; overflow:hidden;
    }
    @media (min-width: 480px){ .arena{ height:420px; } }

    /* ===== Target: red ring + dark fill (mobile-friendly) ===== */
    .target{
      position:absolute;
      width:56px;height:56px;           /* θα υπερκαλυφθεί δυναμικά από JS */
      border-radius:999px;
      background:#171d24;               /* dark fill */
      border:3px solid var(--accent);   /* red ring */
      box-shadow:0 0 0 3px rgba(255,59,59,.18);
      cursor:pointer; z-index:5;
      transition:transform .08s ease, opacity .12s ease;
      will-change:transform,opacity;
      touch-action:manipulation;
    }
    .target:active{ transform:scale(.96); }

    /* shrink όσο «ζει» ο στόχος */
    @keyframes tr-shrink {
      from { transform:scale(1); }
      to   { transform:scale(.86); }
    }

    /* HUD */
    .hud{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px }
    .hud .stat{ flex:1 1 160px }
    .badge.note{ background:#1f2937 }
    .modal{ display:none; }
    .modal.open{ display:block; }
  </style>

  <script type="module">
    import { clamp, getDeviceId, todayKey, fetchJSON } from "/assets/utils.js";

    const deviceId = getDeviceId();

    // Modes: trial = endless practice (τώρα ΜΕΤΡΑΕΙ misses)
    const MODES = {
      default: { label:"Default", lifeMs:1200 },
      hard:    { label:"Hard",    lifeMs:900  },
      trial:   { label:"Trial",   lifeMs:1100, endless:true }
    };

    let mode   = "default";
    let running = false;
    let hits = 0, misses = 0;

    let arenaEl, startBtn, modeSel, howBtn, howModal, closeHow, hitsEl, missesEl, dailyNote;

    const rand = (a,b)=> Math.floor(a + Math.random()*(b-a+1));

    const arenaBounds = ()=>{
      const r = arenaEl.getBoundingClientRect();
      return { w: Math.floor(r.width), h: Math.floor(r.height) };
    };

    function updateHUD(){
      hitsEl.textContent   = hits;
      missesEl.textContent = misses;
    }

    function resetGame(){
      running = false;
      hits = 0; misses = 0; updateHUD();
      // καθάρισε targets
      [...arenaEl.querySelectorAll('.target')].forEach(n=>n.remove());
    }

    function maybeEnd(){
      // Στα non-trial τελειώνουμε με 2 misses (auto-submit θα μπει όταν στήσουμε lb)
      if (!MODES[mode].endless && misses >= 2){
        endGame();
      }
    }

    function startGame(){
      resetGame();
      running = true;
      spawnOne();
    }

    function endGame(){
      running = false;
      // εδώ στο μέλλον: auto submit στο daily leaderboard (όταν ανοίξει endpoint)
      // submitDailyTargetRush({device:deviceId, day:todayKey(), hits, misses, mode});
    }

    function spawnOne(){
      if (!running) return;
      const { w, h } = arenaBounds();

      // ελαφριά τυχαιοποίηση μεγέθους γύρω απ’ το τωρινό
      const size = Math.round(rand(50, 64));
      const pad  = 10;
      const x = clamp(rand(pad, w - size - pad), pad, w - size - pad);
      const y = clamp(rand(pad, h - size - pad), pad, h - size - pad);

      const el = document.createElement('button');
      el.className = 'target';
      el.type = 'button';
      el.style.left   = x + 'px';
      el.style.top    = y + 'px';
      el.style.width  = size + 'px';
      el.style.height = size + 'px';

      const life = MODES[mode].lifeMs;
      el.style.animation = `tr-shrink ${life}ms linear forwards`;

      let handled = false;

      const cleanup = ()=>{
        if (el.isConnected) arenaEl.removeChild(el);
      };

      const expiry = setTimeout(()=>{
        if (!handled){
          misses++; updateHUD(); maybeEnd();
        }
        cleanup();
        if (running) spawnOne();
      }, life);

      el.addEventListener('click', ()=>{
        if (handled) return;
        handled = true;
        clearTimeout(expiry);
        hits++; updateHUD();
        cleanup();
        if (running) spawnOne();
      });

      arenaEl.appendChild(el);
    }

    function openHow(){ howModal.classList.add('open'); }
    function closeHowFn(){ howModal.classList.remove('open'); }

    window.addEventListener('DOMContentLoaded', ()=>{
      arenaEl   = document.getElementById('arena');
      startBtn  = document.getElementById('start');
      modeSel   = document.getElementById('mode');
      howBtn    = document.getElementById('how');
      howModal  = document.getElementById('how-modal');
      closeHow  = document.getElementById('close-how');
      hitsEl    = document.getElementById('hits');
      missesEl  = document.getElementById('misses');
      dailyNote = document.getElementById('trial-note');

      startBtn.addEventListener('click', startGame);
      modeSel.addEventListener('change', (e)=>{
        mode = e.target.value;
        resetGame();
        // Trial note ορατό μόνο στο trial
        dailyNote.style.display = MODES[mode].endless ? 'block' : 'none';
      });
      howBtn.addEventListener('click', openHow);
      closeHow.addEventListener('click', closeHowFn);

      // initial
      updateHUD();
      dailyNote.style.display = 'none';

      // Ad load
      if (window.ChronoAds) ChronoAds.load({ targetId: 'ad-targetrush', slotKey: 'targetrush' });
    });
  </script>
</head>
<body>
<header class="header">
  <a href="/" class="logo"><img src="/assets/logo.svg" alt=""><span class="brand">ChronoHit</span></a>
</header>

<main class="container">
  <!-- TOP AD -->
  <section class="card ad-top">
    <h2>Ad</h2>
    <div id="ad-targetrush" class="placeholder-ad"></div>
  </section>

  <!-- GAME -->
  <section class="card">
    <div class="row">
      <h1 style="margin:0">Target Rush</h1>
      <button id="how" class="btn" type="button">How to play</button>
      <button id="start" class="btn" type="button">Start</button>
      <label class="small" style="margin-left:auto">Mode:</label>
      <select id="mode" class="select" aria-label="Mode">
        <option value="default" selected>Default</option>
        <option value="hard">Hard</option>
        <option value="trial">Trial</option>
      </select>
    </div>

    <p class="lead">
      Hit the shrinking targets as fast as you can.
      <span id="trial-note" class="badge note">Trial mode — endless practice, no leaderboard (yet).</span>
    </p>

    <div id="arena" class="arena"></div>

    <div class="hud">
      <div class="stat">
        <div class="label">Hits</div>
        <div class="value" id="hits">0</div>
      </div>
      <div class="stat">
        <div class="label">Misses</div>
        <div class="value" id="misses">0</div>
      </div>
    </div>

    <p class="small" style="margin-top:10px">No decimals. Anti-cheat will apply globally.</p>
  </section>

  <!-- How to play modal -->
  <section id="how-modal" class="modal card" role="dialog" aria-modal="true" aria-labelledby="how-title">
    <div class="row">
      <h2 id="how-title" style="margin:0">How to play</h2>
      <button id="close-how" class="btn" type="button" style="margin-left:auto">Close</button>
    </div>
    <ul>
      <li>Tap the red-ring target before it disappears.</li>
      <li>Targets slightly shrink as time passes — act fast.</li>
      <li>Non-trial ends after 2 misses. Trial is endless practice.</li>
    </ul>
  </section>
</main>

<footer class="footer">© 2025 ChronoHit — Every millisecond counts</footer>
</body>
</html>
