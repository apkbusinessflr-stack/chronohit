<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sequence Sprint — ChronoHit</title>
  <link rel="stylesheet" href="/assets/chronohit.css" />

  <!-- Make the game UI ~50% smaller & tidy visuals -->
  <style>
    .wrap { display:flex; flex-direction:column; gap:12px; }
    .grid { display:grid; gap:8px; margin:8px 0; }
    /* Half-sized max widths per layout */
    .grid.grid-3x3  { grid-template-columns: repeat(3, 1fr); max-width: 200px; width:100%; }
    .grid.grid-3x4  { grid-template-columns: repeat(3, 1fr); max-width: 230px; width:100%; }
    .grid.grid-4x4  { grid-template-columns: repeat(4, 1fr); max-width: 260px; width:100%; }

    .pad {
      aspect-ratio: 1/1;
      border-radius: 12px;
      background: #0f1722;
      border: 1px solid var(--border);
      box-shadow: inset 0 0 0 2px rgba(255,255,255,0.02);
      transition: transform .06s, background .12s, box-shadow .12s;
    }
    .pad:active { transform: scale(.98); }

    /* Playback flash (game shows the sequence) */
    .pad.show {
      background: #1a2b3d;
      box-shadow: 0 0 10px rgba(255,255,255,.12), inset 0 0 0 2px rgba(255,255,255,.08);
    }

    /* Wrong tap quick flash (we remove it immediately after) */
    .pad.bad {
      background: #3b1e1e;
      box-shadow: 0 0 10px rgba(255,59,59,.25);
    }

    .bar { display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    .small { color: var(--muted); font-size: 12px; }

    dialog.how { max-width:480px; border:1px solid var(--border); border-radius:14px; background:var(--surface); color:var(--text); }
    dialog.how::backdrop { background: rgba(0,0,0,.45); }
  </style>

  <!-- Dynamic loaders -->
  <script src="/assets/ga-loader.js"></script>
  <script src="/assets/ads-loader.js"></script>

  <script type="module">
    import { ls, getDeviceId, todayKey, fetchJSON } from "/assets/utils.js";

    // Modes: grid sizes (half-sized UI via CSS above)
    const MODES = {
      easy:   { label: "Easy 3×3",   rows: 3, cols: 3 },
      medium: { label: "Medium 3×4", rows: 4, cols: 3 },
      hard:   { label: "Hard 4×4",   rows: 4, cols: 4 },
      trial:  { label: "Trial (endless)", rows: 4, cols: 4, endless: true }
    };

    // Playback timing (slightly faster because smaller UI)
    const MIN_SHOW = 240, SHOW_DECAY = 10, MIN_GAP = 70;
    const DAILY_LIMIT = 5;
    const device = getDeviceId();

    let mode = 'easy';
    let sequence = [];
    let inputIdx = 0;
    let locked = false;       // true while playing back sequence
    let running = false;      // true after "Start" pressed
    let longest = 0, current = 0, mistakes = 0, speed = 0;

    let gridEl, infoEl, longestEl, mistakesEl, submitBtn, dailyEl, leaderEl, startBtn, modeSel;

    function rng(n){ return Math.floor(Math.random()*n); }
    function delay(ms){ return new Promise(r=>setTimeout(r,ms)); }

    function classForGrid(rows, cols){
      if (rows===3 && cols===3) return 'grid-3x3';
      if (rows===4 && cols===3) return 'grid-3x4';
      return 'grid-4x4';
    }

    function buildGrid(rows, cols){
      gridEl.className = `grid ${classForGrid(rows, cols)}`;
      gridEl.innerHTML = '';
      const total = rows * cols;
      for (let i=0;i<total;i++){
        const b = document.createElement('button');
        b.className = 'pad';
        b.type = 'button';
        b.dataset.idx = String(i);
        b.addEventListener('click', onPad);
        gridEl.appendChild(b);
      }
    }

    function resetSession(){
      sequence = [];
      inputIdx = 0;
      locked = false;
      current = 0;
      mistakes = 0;
      speed = 0;
      running = false;
      renderStats();
      infoEl.textContent = 'Press Start';
      submitBtn.disabled = true;
    }

    function renderStats(){
      longestEl.textContent = String(longest);
      mistakesEl.textContent = String(mistakes);
    }

    async function showSequence(){
      locked = true;
      const pads = [...gridEl.children];
      const showMs = Math.max(MIN_SHOW, 520 - speed*SHOW_DECAY);
      for (const idx of sequence){
        const el = pads[idx];
        el.classList.add('show');
        await delay(showMs);
        el.classList.remove('show');
        await delay(Math.max(MIN_GAP, showMs/3));
      }
      locked = false;
      infoEl.textContent = 'Repeat!';
    }

    function extendSequence(){
      const total = gridEl.children.length;
      sequence.push(rng(total));
      speed = Math.min(20, sequence.length);
    }

    async function onPad(e){
      // Ignore taps if game hasn't started
      if (!running || locked) return;

      const el = e.currentTarget;
      const idx = Number(el.dataset.idx);
      const expected = sequence[inputIdx];

      // Requirement: when tapping, pad should NOT stay lit.
      // We won't add any "ok" class; only wrong taps flash briefly with 'bad'.
      if (idx === expected){
        inputIdx++;
        if (inputIdx === sequence.length){
          // Round complete
          current++;
          longest = Math.max(longest, current);
          const prev = ls.get('ss.hi', 0);
          if (longest > prev) ls.set('ss.hi', longest);
          renderStats();
          if (!MODES[mode].endless && sequence.length >= 100) {
            infoEl.textContent = 'Max round reached.';
            submitBtn.disabled = false;
            return;
          }
          inputIdx = 0;
          extendSequence();
          infoEl.textContent = 'Watch…';
          await delay(250);
          await showSequence();
        }
      } else {
        // Wrong → quick red flash; never stays on
        el.classList.add('bad');
        setTimeout(()=>el.classList.remove('bad'), 120);
        mistakes++;
        renderStats();
        // Reset to new round
        inputIdx = 0; current = 0; sequence = [];
        infoEl.textContent = 'Oops! New round.';
        extendSequence();
        await delay(320);
        await showSequence();
      }
    }

    async function startGame(){
      if (running) return;
      running = true;
      sequence = [];
      inputIdx = 0;
      current = 0;
      mistakes = 0;
      speed = 0;
      renderStats();
      infoEl.textContent = 'Watch the sequence…';
      extendSequence();
      await delay(300);
      await showSequence();
      // Enable submit if not Trial (score becomes valid after first repeat)
      if (!MODES[mode].endless) submitBtn.disabled = false;
    }

    async function refreshDaily(){
      if (MODES[mode].endless){
        dailyEl.textContent = '∞';
        submitBtn.disabled = true;
        leaderEl.innerHTML = `<div class="notice">Trial mode: endless practice — no leaderboard.</div>`;
        return;
      }
      try{
        const j = await fetchJSON(`/api/daily?game=ss&device=${encodeURIComponent(getDeviceId())}&day=${todayKey()}`);
        dailyEl.textContent = `${j.used}/${DAILY_LIMIT}`;
        // Submit remains enabled while running; but disallow if daily limit reached
        if (j.used >= DAILY_LIMIT) submitBtn.disabled = true;
      }catch{
        dailyEl.textContent = `—/${DAILY_LIMIT}`;
      }
    }

    async function submitScore(){
      if (MODES[mode].endless) return;
      try{
        const r = await fetchJSON('/api/score', {
          method:'POST',
          body: JSON.stringify({
            game:'ss',
            device: getDeviceId(),
            day: todayKey(),
            best: longest,         // longest streak = primary metric
            attempts: mistakes,    // mistakes as secondary
            mode
          })
        });
        alert(r.message || 'Submitted!');
        await refreshDaily();
        await loadLeaderboard();
      }catch(e){
        alert(e.data?.error || e.message || 'Submit failed');
      }
    }

    async function loadLeaderboard(){
      if (MODES[mode].endless) return;
      try{
        const j = await fetchJSON(`/api/leaderboard?game=ss&range=daily&day=${todayKey()}&limit=20`);
        leaderEl.innerHTML = renderTable(j.items||[]);
      }catch{
        leaderEl.innerHTML = `<div class="notice">Leaderboard unavailable.</div>`;
      }
    }

    function renderTable(items){
      if(!items.length) return `<div class="notice">No scores yet today. Be the first!</div>`;
      const rows = items.map((it, i)=>`<tr><td>${i+1}</td><td>${it.longest}</td><td>${it.mistakes}</td><td>${it.mode||'default'}</td></tr>`).join('');
      return `<table class="table"><thead><tr><th>#</th><th>Longest</th><th>Mistakes</th><th>Mode</th></tr></thead><tbody>${rows}</tbody></table>`;
    }

    window.addEventListener('DOMContentLoaded', async ()=>{
      // Wire elements
      gridEl     = document.getElementById('grid');
      infoEl     = document.getElementById('info');
      longestEl  = document.getElementById('longest');
      mistakesEl = document.getElementById('mistakes');
      submitBtn  = document.getElementById('submit');
      dailyEl    = document.getElementById('daily');
      leaderEl   = document.getElementById('leader');
      startBtn   = document.getElementById('start');
      modeSel    = document.getElementById('mode');

      // Build initial grid (no auto-start)
      const { rows, cols } = MODES[mode];
      buildGrid(rows, cols);
      resetSession();

      // Events
      startBtn.addEventListener('click', startGame);
      submitBtn.addEventListener('click', submitScore);
      modeSel.addEventListener('change', async (e)=>{
        mode = e.target.value;
        const m = MODES[mode];
        buildGrid(m.rows, m.cols);
        resetSession();
        await refreshDaily();
        await loadLeaderboard();
      });

      // Ads & data
      if (window.ChronoAds) ChronoAds.load({ targetId: 'ad-sequencesprint', slotKey: 'sequencesprint' });
      await refreshDaily();
      await loadLeaderboard();

      // How-to modal
      document.getElementById('how').addEventListener('click', ()=>document.getElementById('dlg-how').showModal());
      document.getElementById('close-how').addEventListener('click', ()=>document.getElementById('dlg-how').close());
    });
  </script>
</head>
<body>
<header class="header">
  <a href="/" class="logo"><img src="/assets/logo.svg" alt=""><span class="brand">ChronoHit</span></a>
</header>

<main class="container">
  <!-- TOP AD -->
  <section class="card ad-top">
    <h2>Ad</h2>
    <div id="ad-sequencesprint" class="placeholder-ad"></div>
  </section>

  <!-- GAME -->
  <section class="card">
    <div class="bar">
      <h1 style="margin:0">Sequence Sprint</h1>
      <button id="how" class="btn" type="button">How to play</button>
      <button id="start" class="btn" type="button">Start</button>
      <span class="small">Daily: <b id="daily">—/5</b></span>
      <span class="small">Mode:</span>
      <select id="mode" class="select">
        <option value="easy" selected>Easy (3×3)</option>
        <option value="medium">Medium (3×4)</option>
        <option value="hard">Hard (4×4)</option>
        <option value="trial">Trial (endless)</option>
      </select>
    </div>

    <p id="info" class="lead">Press Start</p>

    <div class="wrap">
      <div id="grid" class="grid grid-3x3" aria-label="Pads grid"></div>

      <div class="stats">
        <div class="stat"><div class="label">Longest</div><div class="value" id="longest">0</div></div>
        <div class="stat"><div class="label">Mistakes</div><div class="value" id="mistakes">0</div></div>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="submit" class="btn" type="button" disabled>Submit to Daily Leaderboard</button>
      </div>

      <div id="leader" style="margin-top:12px"></div>
      <p class="small">No numbers on pads. Playback lights show the sequence. Your taps never remain lit.</p>
    </div>
  </section>
</main>

<footer class="footer">© 2025 ChronoHit — Every millisecond counts</footer>

<!-- How-to dialog -->
<dialog id="dlg-how" class="how">
  <h3>How to play</h3>
  <ul>
    <li>Press <b>Start</b> to begin.</li>
    <li>Watch the pads light up — that’s the sequence.</li>
    <li>Repeat the sequence by tapping the same pads.</li>
    <li>Each round adds +1 step. Longest streak wins.</li>
  </ul>
  <div style="text-align:right"><button id="close-how" class="btn" type="button">Got it</button></div>
</dialog>
</body>
</html>
