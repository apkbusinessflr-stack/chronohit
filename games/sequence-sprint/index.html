<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sequence Sprint — ChronoHit</title>
  <link rel="stylesheet" href="/assets/chronohit.css" />
  <style>
    .grid { display:grid; gap:10px; margin:10px 0; }
    .pad { aspect-ratio:1/1; border-radius:14px; background:#0f1722; border:1px solid var(--border);
           box-shadow: inset 0 0 0 2px rgba(255,255,255,0.02); transition:transform .06s, background .12s; }
    .pad:active { transform: scale(.98); }
    .pad.show { background:#1a2b3d; }
    .pad.ok { background:#163221; }
    .pad.bad { background:#3b1e1e; }
    .bar { display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
    dialog.how { max-width:520px; border:1px solid var(--border); border-radius:16px; background:var(--surface); color:var(--text); }
    dialog.how::backdrop { background: rgba(0,0,0,.4); }
  </style>

  <script src="/assets/ga-loader.js"></script>
  <script src="/assets/ads-loader.js"></script>
  <script type="module">
    import { ls, getDeviceId, todayKey, fetchJSON } from "/assets/utils.js";

    const device = getDeviceId();
    const DAILY_LIMIT = 5;
    const MIN_SHOW = 280, SHOW_DECAY = 10, MIN_GAP = 80;
    const MODES = {
      easy:   { label:"Easy 3×3",   rows:3, cols:3 },
      medium: { label:"Medium 3×4", rows:4, cols:3 },
      hard:   { label:"Hard 4×4",   rows:4, cols:4 },
      trial:  { label:"Trial (endless)", rows:4, cols:4, endless:true }
    };

    let mode = 'easy', sequence = [], inputIdx = 0, locked = false;
    let longest = 0, current = 0, mistakes = 0, speed = 0;

    let gridEl, infoEl, longestEl, mistakesEl, submitBtn, dailyEl, leaderEl;

    function rng(max){ return Math.floor(Math.random()*max); }
    function delay(ms){ return new Promise(r=>setTimeout(r,ms)); }

    function buildGrid(r,c){
      gridEl.innerHTML = '';
      gridEl.style.gridTemplateColumns = `repeat(${c}, 1fr)`;
      const total = r*c;
      for(let i=0;i<total;i++){
        const d = document.createElement('button');
        d.className = 'pad';
        d.type = 'button';
        d.dataset.idx = String(i);
        d.addEventListener('click', onPad);
        gridEl.appendChild(d);
      }
    }

    function resetSession(){
      sequence = [];
      inputIdx = 0;
      locked = false;
      current = 0;
      mistakes = 0;
      speed = 0;
      renderStats();
      infoEl.textContent = 'Watch the sequence…';
    }

    function renderStats(){
      longestEl.textContent = String(longest);
      mistakesEl.textContent = String(mistakes);
    }

    async function showSequence(){
      locked = true;
      const pads = [...gridEl.children];
      const showMs = Math.max(MIN_SHOW, 600 - speed*SHOW_DECAY);
      for(const idx of sequence){
        pads[idx].classList.add('show');
        await delay(showMs);
        pads[idx].classList.remove('show');
        await delay(Math.max(MIN_GAP, showMs/3));
      }
      locked = false;
      infoEl.textContent = 'Repeat!';
    }

    function extendSequence(){
      const total = gridEl.children.length;
      sequence.push(rng(total));
      speed = Math.min(20, sequence.length);
    }

    async function onPad(e){
      if (locked) return;
      const idx = Number(e.currentTarget.dataset.idx);
      const expected = sequence[inputIdx];
      if (idx === expected){
        e.currentTarget.classList.add('ok');
        setTimeout(()=>e.currentTarget.classList.remove('ok'), 130);
        inputIdx++;
        if (inputIdx === sequence.length){
          current++;
          longest = Math.max(longest, current);
          renderStats();
          if (!MODES[mode].endless && sequence.length >= 100) return; // safety stop
          inputIdx = 0;
          extendSequence();
          infoEl.textContent = 'Watch…';
          await delay(300);
          await showSequence();
        }
      } else {
        e.currentTarget.classList.add('bad');
        setTimeout(()=>e.currentTarget.classList.remove('bad'), 160);
        mistakes++;
        renderStats();
        // new round
        inputIdx = 0; current = 0; sequence = [];
        infoEl.textContent = 'Oops! New round.';
        extendSequence();
        await delay(400);
        await showSequence();
      }
    }

    async function startGame(){
      resetSession();
      extendSequence();
      await delay(350);
      await showSequence();
    }

    async function refreshDaily(){
      if (MODES[mode].endless){
        dailyEl.textContent = '∞';
        submitBtn.disabled = true;
        leaderEl.innerHTML = `<div class="notice">Trial mode: endless practice — no leaderboard.</div>`;
        return;
      }
      try{
        const j = await fetchJSON(`/api/daily?game=ss&device=${encodeURIComponent(device)}&day=${todayKey()}`);
        dailyEl.textContent = `${j.used}/${DAILY_LIMIT}`;
        submitBtn.disabled = (j.used >= DAILY_LIMIT) || longest < 1;
      }catch{
        dailyEl.textContent = `—/${DAILY_LIMIT}`;
        submitBtn.disabled = longest < 1;
      }
    }

    async function submitScore(){
      if (MODES[mode].endless) return;
      try{
        const r = await fetchJSON('/api/score', {
          method:'POST',
          body: JSON.stringify({
            game:'ss', device, day:todayKey(),
            best: longest, attempts: mistakes, mode
          })
        });
        alert(r.message || 'Submitted!');
        await refreshDaily();
        await loadLeaderboard();
      }catch(e){ alert(e.data?.error || e.message || 'Submit failed'); }
    }

    async function loadLeaderboard(){
      if (MODES[mode].endless) return;
      try{
        const j = await fetchJSON(`/api/leaderboard?game=ss&range=daily&day=${todayKey()}&limit=20`);
        leaderEl.innerHTML = renderTable(j.items||[]);
      }catch{ leaderEl.innerHTML = `<div class="notice">Leaderboard unavailable.</div>`; }
    }

    function renderTable(items){
      if(!items.length) return `<div class="notice">No scores yet today. Be the first!</div>`;
      const rows = items.map((it, i)=>`<tr><td>${i+1}</td><td>${it.longest}</td><td>${it.mistakes}</td><td>${it.mode}</td></tr>`).join('');
      return `<table class="table"><thead><tr><th>#</th><th>Longest</th><th>Mistakes</th><th>Mode</th></tr></thead><tbody>${rows}</tbody></table>`;
    }

    window.addEventListener('DOMContentLoaded', async ()=>{
      gridEl = document.getElementById('grid');
      infoEl = document.getElementById('info');
      longestEl = document.getElementById('longest');
      mistakesEl = document.getElementById('mistakes');
      submitBtn = document.getElementById('submit');
      dailyEl = document.getElementById('daily');
      leaderEl = document.getElementById('leader');

      const modeSel = document.getElementById('mode');
      modeSel.addEventListener('change', async (e)=>{
        mode = e.target.value;
        const { rows, cols } = MODES[mode];
        buildGrid(rows, cols);
        await refreshDaily();
        await loadLeaderboard();
        startGame();
      });

      // Build initial grid
      buildGrid(MODES[mode].rows, MODES[mode].cols);
      await refreshDaily();
      await loadLeaderboard();
      startGame();

      // Top ad
      if (window.ChronoAds) ChronoAds.load({ targetId:'ad-ss', slotKey:'sequencesprint' });

      // How to play modal
      document.getElementById('how').addEventListener('click', ()=>{
        document.getElementById('dlg-how').showModal();
      });
      document.getElementById('close-how').addEventListener('click', ()=>{
        document.getElementById('dlg-how').close();
      });
    });
  </script>
</head>
<body>
<header class="header">
  <a href="/" class="logo"><img src="/assets/logo.svg" alt=""><span class="brand">ChronoHit</span></a>
</header>

<main class="container">
  <section class="card ad-top">
    <h2>Ad</h2>
    <div id="ad-ss" class="placeholder-ad"></div>
  </section>

  <section class="card">
    <div class="bar">
      <h1 style="margin:0">Sequence Sprint</h1>
      <button id="how" class="btn" type="button">How to play</button>
      <span class="small">Daily: <b id="daily">—/5</b></span>
      <span class="small">Mode:</span>
      <select id="mode" class="select">
        <option value="easy">Easy (3×3)</option>
        <option value="medium">Medium (3×4)</option>
        <option value="hard">Hard (4×4)</option>
        <option value="trial">Trial (endless)</option>
      </select>
    </div>
    <p id="info" class="lead">Watch the sequence…</p>
    <div id="grid" class="grid"></div>

    <div class="stats">
      <div class="stat"><div class="label">Longest</div><div class="value mono" id="longest">0</div></div>
      <div class="stat"><div class="label">Mistakes</div><div class="value mono" id="mistakes">0</div></div>
    </div>

    <div class="row" style="margin-top:10px">
      <button id="submit" class="btn" type="button">Submit to Daily Leaderboard</button>
    </div>

    <div id="leader" style="margin-top:12px"></div>
  </section>
</main>

<footer class="footer">© 2025 ChronoHit — Every millisecond counts</footer>

<dialog id="dlg-how" class="how">
  <h3>How to play</h3>
  <ul>
    <li>Watch the pads light up — that’s the sequence.</li>
    <li>Repeat the same sequence by tapping the pads.</li>
    <li>Each round adds +1 step. Longest streak wins.</li>
  </ul>
  <div style="text-align:right"><button id="close-how" class="btn" type="button">Got it</button></div>
</dialog>
</body>
</html>
